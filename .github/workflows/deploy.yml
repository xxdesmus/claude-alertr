name: Deploy

on:
  repository_dispatch:
    types: [deploy]
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Get scoped deploy token
        id: get-token
        run: |
          RESPONSE=$(curl -s -X POST "https://codenow.dev/api/v1/deploy-tokens" \
            -H "Content-Type: application/json" \
            -d '{"deploy_secret": "'${{ secrets.CLAUDE_SETUP_DEPLOY_SECRET }}'"}')

          # Check if request was successful
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "Failed to get deploy token: $(echo "$RESPONSE" | jq -r '.error')"
            exit 1
          fi

          # Extract token, account_id, and deployment_id
          TOKEN=$(echo "$RESPONSE" | jq -r '.data.token')
          ACCOUNT_ID=$(echo "$RESPONSE" | jq -r '.data.account_id')
          DEPLOYMENT_ID=$(echo "$RESPONSE" | jq -r '.data.deployment_id')
          EXPIRES_AT=$(echo "$RESPONSE" | jq -r '.data.expires_at')

          echo "Deploy token obtained (expires: $EXPIRES_AT)"
          echo "Deployment ID: $DEPLOYMENT_ID"

          # Set outputs (masked token)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      - name: Deploy to Cloudflare Workers
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.get-token.outputs.token }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.get-token.outputs.account_id }}
        run: |
          # Run deploy and capture output
          OUTPUT=$(npm run deploy 2>&1) || {
            echo "$OUTPUT"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=Deployment failed" >> $GITHUB_OUTPUT
            exit 1
          }
          echo "$OUTPUT"

          # Extract deployed URL - prefer custom domain over workers.dev/pages.dev
          # Custom domains appear as: "example.com/* (zone name: example.com)"
          CUSTOM_DOMAIN=$(echo "$OUTPUT" | grep -oE '^[[:space:]]+[a-zA-Z0-9.-]+/\*' | head -1 | sed 's|[[:space:]]*||;s|/\*||')
          DEFAULT_URL=$(echo "$OUTPUT" | grep -oE 'https://[a-zA-Z0-9.-]+\.(workers|pages)\.dev' | head -1)

          if [ -n "$CUSTOM_DOMAIN" ]; then
            WORKER_URL="https://$CUSTOM_DOMAIN"
          else
            WORKER_URL="$DEFAULT_URL"
          fi

          VERSION_ID=$(echo "$OUTPUT" | grep -oE 'Current Version ID: [a-f0-9-]+' | cut -d' ' -f4)

          echo "Deployed URL: $WORKER_URL"
          echo "Version ID: $VERSION_ID"

          echo "status=success" >> $GITHUB_OUTPUT
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "version_id=$VERSION_ID" >> $GITHUB_OUTPUT

      - name: Report deployment result
        if: always()
        run: |
          curl -s -X POST "https://codenow.dev/api/v1/deploy-tokens/callback" \
            -H "Content-Type: application/json" \
            -d '{
              "deploy_secret": "'${{ secrets.CLAUDE_SETUP_DEPLOY_SECRET }}'",
              "deployment_id": "'${{ steps.get-token.outputs.deployment_id }}'",
              "status": "'${{ steps.deploy.outputs.status || 'failed' }}'",
              "worker_url": "'${{ steps.deploy.outputs.worker_url }}'",
              "version_id": "'${{ steps.deploy.outputs.version_id }}'",
              "error": "'${{ steps.deploy.outputs.error }}'"
            }'
