#!/usr/bin/env bash
#
# claude-alertr installer
# Installs claude-alertr hooks into Claude Code's global settings.
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="$HOME/.claude-alertr"
HOOKS_DIR="$INSTALL_DIR/hooks"
CONFIG_FILE="$INSTALL_DIR/config"
CLAUDE_SETTINGS="$HOME/.claude/settings.json"

echo "=== claude-alertr installer ==="
echo ""
echo "Tip: You can also install via the Claude Code plugin marketplace:"
echo "  /plugin marketplace add xxdesmus/claude-alertr"
echo "  /plugin install claude-alertr@xxdesmus-claude-alertr"
echo "  /claude-alertr:setup"
echo ""

# --- Install hooks ---
mkdir -p "$HOOKS_DIR"
cp "$SCRIPT_DIR/plugins/claude-alertr/hooks/idle-alert.sh" "$HOOKS_DIR/idle-alert.sh"
cp "$SCRIPT_DIR/plugins/claude-alertr/hooks/dismiss-alert.sh" "$HOOKS_DIR/dismiss-alert.sh"
chmod +x "$HOOKS_DIR/idle-alert.sh" "$HOOKS_DIR/dismiss-alert.sh"
echo "Hooks installed to $HOOKS_DIR"

# --- Create config if it doesn't exist ---
if [ ! -f "$CONFIG_FILE" ]; then
  echo ""
  echo "No config file found. Let's set one up."
  echo ""

  # Worker URL
  read -rp "Enter your claude-alertr Worker URL (e.g. https://claude-alertr.you.workers.dev): " worker_url
  if [ -z "$worker_url" ]; then
    echo "Error: Worker URL is required."
    exit 1
  fi

  # Auth token (required)
  read -rp "Enter your AUTH_TOKEN (must match the Worker secret): " auth_token
  if [ -z "$auth_token" ]; then
    echo "Error: AUTH_TOKEN is required. Set one on the Worker with: wrangler secret put AUTH_TOKEN"
    exit 1
  fi

  # Alert delay
  read -rp "Alert delay in seconds [60]: " delay
  delay="${delay:-60}"

  cat > "$CONFIG_FILE" <<CONF
# claude-alertr configuration
# Generated by install.sh

# URL of your deployed claude-alertr Cloudflare Worker
CLAUDE_ALERTR_URL="$worker_url"

# Auth token (must match AUTH_TOKEN secret on the Worker)
CLAUDE_ALERTR_TOKEN="$auth_token"

# Seconds to wait before sending an alert (default: 60)
CLAUDE_ALERTR_DELAY="$delay"
CONF

  chmod 600 "$CONFIG_FILE"
  echo "Config written to $CONFIG_FILE"
else
  echo "Config already exists at $CONFIG_FILE â€” skipping."
fi

# --- Update Claude Code global settings (merge, don't overwrite) ---
echo ""
echo "Configuring Claude Code hooks..."

mkdir -p "$HOME/.claude"

if [ -f "$CLAUDE_SETTINGS" ]; then
  EXISTING=$(cat "$CLAUDE_SETTINGS")
else
  EXISTING="{}"
fi

# Merge hooks into existing configuration, preserving other hooks.
# First removes any existing claude-alertr entries, then appends ours.
UPDATED=$(echo "$EXISTING" | jq \
  --arg idle_hook "$HOOKS_DIR/idle-alert.sh" \
  --arg dismiss_hook "$HOOKS_DIR/dismiss-alert.sh" \
  '
  .hooks //= {} |
  .hooks.Notification //= [] |
  .hooks.UserPromptSubmit //= [] |
  .hooks.Notification = [.hooks.Notification[] | select((.hooks[0].command // "") | test("claude-alertr") | not)] + [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": $idle_hook,
          "timeout": 5
        }
      ]
    }
  ] |
  .hooks.UserPromptSubmit = [.hooks.UserPromptSubmit[] | select((.hooks[0].command // "") | test("claude-alertr") | not)] + [
    {
      "matcher": "",
      "hooks": [
        {
          "type": "command",
          "command": $dismiss_hook,
          "timeout": 5
        }
      ]
    }
  ]
  ')

echo "$UPDATED" | jq '.' > "$CLAUDE_SETTINGS"
echo "Claude Code settings updated at $CLAUDE_SETTINGS"

echo ""
echo "=== Installation complete ==="
echo ""
echo "Next steps:"
echo "  1. Deploy the Worker:  cd $(printf '%q' "$SCRIPT_DIR") && npm run deploy"
echo "  2. Set Worker secrets: wrangler secret put AUTH_TOKEN"
echo "     Then: wrangler secret put WEBHOOK_URL"
echo "     (and/or RESEND_API_KEY, ALERT_EMAIL_TO for email)"
echo "  3. Test it:            curl -X POST -H 'Authorization: Bearer <TOKEN>' https://your-worker.workers.dev/test"
echo ""
echo "To uninstall, run: $(printf '%q' "$SCRIPT_DIR")/uninstall.sh"
